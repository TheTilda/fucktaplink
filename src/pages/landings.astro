---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Лендинги" description="Управление лендингами">
	<section class="mx-auto flex max-w-4xl flex-col gap-6 px-4 py-10 sm:py-14">
		<header class="flex items-center justify-between">
			<div class="space-y-1">
				<p class="text-xs uppercase tracking-[0.2em] text-slate-500">Кабинет</p>
				<h1 class="text-3xl font-bold text-slate-900">Мои лендинги</h1>
			</div>
			<div class="flex gap-2">
				<a
					href="/dashboard"
					class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100"
				>
					Ссылки
				</a>
				<button
					id="logout-btn"
					class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
				>
					Выйти
				</button>
			</div>
		</header>

		<form id="landing-form" class="grid grid-cols-1 gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-[0_1px_0_#e2e8f0] sm:grid-cols-2">
			<input type="hidden" id="edit-id" name="editId" />
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Slug (URL) *</span>
				<input id="input-slug" name="slug" required pattern="[a-z0-9-]+" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="my-product" />
				<p class="text-xs text-slate-500">Только латинские буквы, цифры и дефисы. Будет доступен по адресу /l/your-slug</p>
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Название товара *</span>
				<input id="input-title" name="title" required class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="Название товара" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Описание *</span>
				<textarea id="input-description" name="description" required rows="3" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="Описание товара"></textarea>
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>Рейтинг</span>
				<input id="input-rating" name="rating" type="number" min="0" max="5" step="0.1" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="5.0" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>Отзывов</span>
				<input id="input-reviews" name="reviews" type="number" min="0" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="0" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>Покупок</span>
				<input id="input-purchases" name="purchases" type="number" min="0" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="0" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Wildberries URL</span>
				<input id="input-link-wb" name="linkWb" type="url" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="https://www.wildberries.ru/..." />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Ozon URL</span>
				<input id="input-link-ozon" name="linkOzon" type="url" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="https://www.ozon.ru/..." />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>Яндекс Маркет URL</span>
				<input id="input-link-ym" name="linkYm" type="url" class="rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="https://market.yandex.ru/..." />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>Вариант верстки:</span>
				<select id="select-layout" name="layoutType" class="rounded-lg border border-slate-200 px-3 py-2 text-sm">
					<option value="standard">Стандартный</option>
					<option value="compact">Компактный</option>
				</select>
				<p class="text-xs text-slate-500">Компактный вариант показывает всю страницу без прокрутки</p>
			</label>
			<div class="flex items-center gap-2 text-sm text-slate-700">
				<span>Статус:</span>
				<select id="select-status" name="status" class="rounded-lg border border-slate-200 px-3 py-2 text-sm">
					<option value="active">Активен</option>
					<option value="inactive">Выключен</option>
				</select>
			</div>
			<div class="flex flex-wrap items-center gap-3 sm:col-span-2">
				<button
					type="submit"
					id="submit-btn"
					class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 active:translate-y-[1px]"
				>
					Создать
				</button>
				<button
					type="button"
					id="cancel-btn"
					class="hidden rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
				>
					Отмена
				</button>
				<input id="upload-file" type="file" accept="image/*" class="hidden" />
				<button
					type="button"
					id="choose-image"
					class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
				>
					Добавить изображение
				</button>
				<span id="file-name" class="text-xs text-slate-500">Файл не выбран</span>
			</div>
			<p id="form-error" class="text-xs text-rose-600 hidden sm:col-span-2">Ошибка сохранения</p>
		</form>

		<div class="space-y-3">
			<h2 class="text-xl font-semibold text-slate-900">Лендинги</h2>
			<div id="landings-list" class="grid grid-cols-1 gap-3 sm:grid-cols-2"></div>
			<p id="landings-empty" class="text-sm text-slate-500 hidden">Лендингов пока нет.</p>
		</div>
	</section>

	<script type="module">
		const logoutBtn = document.getElementById('logout-btn');
		const listEl = document.getElementById('landings-list');
		const emptyEl = document.getElementById('landings-empty');
		const form = document.getElementById('landing-form');
		const errorEl = document.getElementById('form-error');
		const fileInput = document.getElementById('upload-file');
		const chooseBtn = document.getElementById('choose-image');
		const fileName = document.getElementById('file-name');
		const editIdInput = document.getElementById('edit-id');
		const submitBtn = document.getElementById('submit-btn');
		const cancelBtn = document.getElementById('cancel-btn');
		const inputSlug = document.getElementById('input-slug');
		const inputTitle = document.getElementById('input-title');
		const inputDescription = document.getElementById('input-description');
		const inputRating = document.getElementById('input-rating');
		const inputReviews = document.getElementById('input-reviews');
		const inputPurchases = document.getElementById('input-purchases');
		const inputLinkWb = document.getElementById('input-link-wb');
		const inputLinkOzon = document.getElementById('input-link-ozon');
		const inputLinkYm = document.getElementById('input-link-ym');
		const selectLayout = document.getElementById('select-layout');
		const selectStatus = document.getElementById('select-status');

		let currentLandings = [];
		let chosenFile = null;
		let editingId = null;

		const fetchLandings = async () => {
			const res = await fetch('/api/landings');
			if (!res.ok) {
				if (res.status === 401) window.location.href = '/login';
				return;
			}
			const data = await res.json();
			currentLandings = data.landings || [];
			renderList();
		};

		const resetForm = () => {
			form.reset();
			fileInput.value = '';
			fileName.textContent = 'Файл не выбран';
			chosenFile = null;
			editingId = null;
			editIdInput.value = '';
			submitBtn.textContent = 'Создать';
			cancelBtn.classList.add('hidden');
		};

		const startEdit = (item) => {
			editingId = item.id;
			editIdInput.value = item.id;
			inputSlug.value = item.slug;
			inputTitle.value = item.title;
			inputDescription.value = item.description;
			inputRating.value = item.rating || '';
			inputReviews.value = item.reviews || '';
			inputPurchases.value = item.purchases || '';
			inputLinkWb.value = item.linkWb || '';
			inputLinkOzon.value = item.linkOzon || '';
			inputLinkYm.value = item.linkYm || '';
			selectLayout.value = item.layoutType || 'standard';
			selectStatus.value = item.status || 'active';
			fileName.textContent = item.imageUrl ? 'Текущее изображение сохранено' : 'Файл не выбран';
			chosenFile = null;
			submitBtn.textContent = 'Сохранить';
			cancelBtn.classList.remove('hidden');
			form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		};

		const renderList = () => {
			listEl.innerHTML = '';
			if (!currentLandings.length) {
				emptyEl.classList.remove('hidden');
				return;
			}
			emptyEl.classList.add('hidden');
			for (const item of currentLandings) {
				const card = document.createElement('div');
				card.className =
					'rounded-2xl border border-slate-200 bg-white p-4 shadow-[0_1px_0_#e2e8f0] flex flex-col gap-2';
				card.innerHTML = `
					<div class="flex flex-col gap-1">
						${item.imageUrl ? `<img src="${item.imageUrl}" class="h-24 w-full rounded-xl object-cover border border-slate-100" />` : ''}
						<a href="/l/${item.slug}" target="_blank" class="text-sm font-semibold text-slate-900 hover:underline">${item.title}</a>
						<p class="text-xs text-slate-500 truncate">${item.description}</p>
						<p class="text-xs text-slate-500">Просмотров: ${item.views ?? 0}</p>
						<p class="text-xs text-slate-500">URL: /l/${item.slug}</p>
					</div>
					<div class="flex gap-2">
						<button data-id="${item.id}" class="edit-btn rounded-lg border border-slate-300 bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-100">Редактировать</button>
						<button data-id="${item.id}" class="del-btn rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-100">Удалить</button>
					</div>
				`;
				listEl.appendChild(card);
			}
			listEl.querySelectorAll('.del-btn').forEach((btn) =>
				btn.addEventListener('click', async () => {
					const id = Number(btn.dataset.id);
					await fetch('/api/landings', {
						method: 'DELETE',
						headers: { 'content-type': 'application/json' },
						body: JSON.stringify({ id })
					});
					await fetchLandings();
				})
			);
			listEl.querySelectorAll('.edit-btn').forEach((btn) =>
				btn.addEventListener('click', () => {
					const id = Number(btn.dataset.id);
					const item = currentLandings.find((l) => l.id === id);
					if (item) startEdit(item);
				})
			);
		};

		chooseBtn.addEventListener('click', () => fileInput.click());
		fileInput.addEventListener('change', () => {
			const file = fileInput.files?.[0];
			chosenFile = file || null;
			fileName.textContent = file ? file.name : 'Файл не выбран';
		});

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			errorEl.classList.add('hidden');
			let imageUrl = null;
			
			if (chosenFile) {
				const uploadFormData = new FormData();
				uploadFormData.append('file', chosenFile);
				
				const uploadRes = await fetch('/api/upload', {
					method: 'POST',
					body: uploadFormData
				});
				if (!uploadRes.ok) {
					errorEl.textContent = 'Не удалось загрузить файл';
					errorEl.classList.remove('hidden');
					return;
				}
				const upload = await uploadRes.json();
				imageUrl = upload.url;
			} else if (editingId) {
				const currentItem = currentLandings.find((l) => l.id === editingId);
				if (currentItem?.imageUrl) {
					imageUrl = currentItem.imageUrl;
				}
			}

			const payload = {
				slug: inputSlug.value.toLowerCase().trim(),
				title: inputTitle.value,
				description: inputDescription.value,
				rating: inputRating.value ? parseFloat(inputRating.value) : 0,
				reviews: inputReviews.value ? parseInt(inputReviews.value) : 0,
				purchases: inputPurchases.value ? parseInt(inputPurchases.value) : 0,
				linkWb: inputLinkWb.value || undefined,
				linkOzon: inputLinkOzon.value || undefined,
				linkYm: inputLinkYm.value || undefined,
				layoutType: selectLayout.value,
				status: selectStatus.value,
				...(imageUrl && { imageUrl })
			};

			const method = editingId ? 'PUT' : 'POST';
			if (editingId) {
				payload.id = editingId;
			}

			const res = await fetch('/api/landings', {
				method,
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if (!res.ok) {
				const error = await res.json();
				errorEl.textContent = error.message || 'Ошибка сохранения';
				errorEl.classList.remove('hidden');
				return;
			}
			resetForm();
			await fetchLandings();
		});

		cancelBtn.addEventListener('click', () => {
			resetForm();
		});

		logoutBtn.addEventListener('click', async () => {
			await fetch('/api/auth/logout', { method: 'POST' });
			window.location.href = '/login';
		});

		fetchLandings();
	</script>
</BaseLayout>

