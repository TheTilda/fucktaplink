---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" description="–°–æ–∑–¥–∞–Ω–∏–µ JSON-–∑–∞–ø–∏—Å–∏ –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞">
	<section class="mx-auto flex max-w-3xl flex-col gap-6 px-4 py-10 sm:py-14">
		<header class="space-y-2">
			<p class="text-xs uppercase tracking-[0.2em] text-slate-500">–ê–¥–º–∏–Ω</p>
			<h1 class="text-3xl font-bold text-slate-900">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h1>
			<p class="text-base text-slate-600">
				–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî –ø–æ–ª—É—á–∏—Ç–µ JSON-–∑–∞–ø–∏—Å—å –¥–ª—è —Ñ–∞–π–ª–∞ <code>src/data/products.json</code>. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
				–ø–æ–ª–æ–∂–∏—Ç–µ –≤ <code>src/assets/</code> –∏ —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –∏–º—è.
			</p>
		</header>

		<form id="product-form" class="grid grid-cols-1 gap-4 sm:grid-cols-2 hidden">
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>–ù–∞–∑–≤–∞–Ω–∏–µ *</span>
				<input name="title" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>Slug *</span>
				<input name="slug" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="soocas-d3-pro" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700 sm:col-span-2">
				<span>–û–ø–∏—Å–∞–Ω–∏–µ *</span>
				<textarea name="description" required rows="3" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤"></textarea>
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>–ò–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è *</span>
				<input name="image" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="image.webp" />
			</label>
			<div class="flex flex-col gap-2 text-sm text-slate-700">
				<span class="text-sm font-medium text-slate-700">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</span>
				<div class="flex items-center gap-3">
					<button
						type="button"
						id="image-upload-btn"
						class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
					>
						–í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
					</button>
					<span id="image-filename" class="text-xs text-slate-500">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
				</div>
				<input
					id="image-file"
					type="file"
					accept="image/*"
					style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;"
				/>
				<img id="image-preview" class="mt-2 h-24 w-24 rounded-xl border border-slate-200 object-cover" alt="–ü—Ä–µ–≤—å—é" />
			</div>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>–†–µ–π—Ç–∏–Ω–≥ *</span>
				<input name="rating" type="number" min="0" max="5" step="0.1" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="4.7" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>–û—Ç–∑—ã–≤–æ–≤ *</span>
				<input name="reviews" type="number" min="0" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="853" />
			</label>
			<label class="flex flex-col gap-1 text-sm text-slate-700">
				<span>–ü–æ–∫—É–ø–æ–∫ *</span>
				<input name="purchases" type="number" min="0" required class="rounded-lg border border-slate-200 px-3 py-2" placeholder="11000" />
			</label>
			<div class="sm:col-span-2 grid grid-cols-1 gap-3 sm:grid-cols-3">
				<label class="flex flex-col gap-1 text-sm text-slate-700">
					<span>Wildberries URL</span>
					<input name="wb" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="https://www.wildberries.ru/..." />
				</label>
				<label class="flex flex-col gap-1 text-sm text-slate-700">
					<span>Ozon URL</span>
					<input name="ozon" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="https://www.ozon.ru/..." />
				</label>
				<label class="flex flex-col gap-1 text-sm text-slate-700">
					<span>–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç URL</span>
					<input name="ym" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="https://market.yandex.ru/..." />
				</label>
			</div>
			<div class="sm:col-span-2 flex flex-wrap items-center gap-3">
				<button
					type="submit"
					class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 active:translate-y-[1px]"
				>
					–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
				</button>
				<button
					type="button"
					id="reset-btn"
					class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
				>
					–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
				</button>
				<span id="edit-label" class="text-xs text-amber-700 font-semibold hidden">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
			</div>
		</form>

		<div class="space-y-4">
			<div class="flex flex-wrap items-center gap-2">
				<button
					id="copy-btn"
					class="rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 active:translate-y-[1px]"
					type="button"
				>
					–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON
				</button>
				<button
					id="download-json-btn"
					class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-900 transition hover:bg-slate-100 active:translate-y-[1px]"
					type="button"
				>
					–°–∫–∞—á–∞—Ç—å products.json
				</button>
				<button
					id="save-fs-btn"
					class="rounded-lg border border-amber-400 bg-amber-50 px-3 py-2 text-sm font-semibold text-amber-900 transition hover:bg-amber-100 active:translate-y-[1px]"
					type="button"
				>
					–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç)
				</button>
			</div>
			<pre id="json-output" class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-800 overflow-x-auto"></pre>
			<p class="text-xs text-slate-500">
				–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ/—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ—Å—å –º–∞—Å—Å–∏–≤ <code>products.json</code> (–¥–æ–±–∞–≤–∏—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º).
				–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç File System Access API (Chrome) ‚Äî –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞, –∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—à—É—Ç—Å—è –≤
				<code>src/data/products.json</code>, –∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –≤ <code>src/assets/</code>.
			</p>
		</div>

		<div class="space-y-3">
			<h2 class="text-xl font-semibold text-slate-900">–ö–∞—Ä—Ç–æ—á–∫–∏</h2>
			<div id="products-list" class="grid grid-cols-1 gap-3 sm:grid-cols-2 hidden"></div>
			<p class="text-xs text-slate-500 hidden" id="list-hint">–ö–∞—Ä—Ç–æ—á–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç JSON –Ω–∏–∂–µ.</p>
		</div>
	</section>

	<script type="module">
		const apiBase = '/api/products';
		const form = document.getElementById('product-form');
		const output = document.getElementById('json-output');
		const copyBtn = document.getElementById('copy-btn');
		const downloadJsonBtn = document.getElementById('download-json-btn');
		const saveFsBtn = document.getElementById('save-fs-btn');
		const resetBtn = document.getElementById('reset-btn');
		const editLabel = document.getElementById('edit-label');
		const listEl = document.getElementById('products-list');
		const imageInput = document.getElementById('image-file');
		const imageButton = document.getElementById('image-upload-btn');
		const imagePreview = document.getElementById('image-preview');
		const imageFilename = document.getElementById('image-filename');
		let selectedFile = null;
		let imageDataUrl = null;
		let editingSlug = null;

		const slugify = (value) =>
			value
				.toLowerCase()
				.trim()
				.normalize('NFD')
				.replace(/[\u0300-\u036f]/g, '')
				.replace(/[^a-z0-9]+/g, '-')
				.replace(/(^-|-$)/g, '')
				|| 'product-slug';

		const loadFromStorage = () => {
			try {
				const stored = localStorage.getItem('mp-products');
				if (!stored) return null;
				return JSON.parse(stored);
			} catch {
				return null;
			}
		};

		let products = loadFromStorage() || [];

		const persist = () => {
			localStorage.setItem('mp-products', JSON.stringify(products));
		};

		const buildJSON = () => {
			const data = new FormData(form);
			const title = data.get('title')?.toString().trim() || '';
			const slugInput = data.get('slug')?.toString().trim() || '';
			const slug = slugInput || slugify(title);

			const json = {
				slug,
				title,
				description: data.get('description')?.toString().trim() || '',
				image: data.get('image')?.toString().trim() || '',
				rating: Number(data.get('rating') || 0) || 0,
				reviews: Number(data.get('reviews') || 0) || 0,
				purchases: Number(data.get('purchases') || 0) || 0,
				links: {
					wb: data.get('wb')?.toString().trim() || '',
					ozon: data.get('ozon')?.toString().trim() || '',
					ym: data.get('ym')?.toString().trim() || ''
				},
				imageDataUrl
			};

			const merged = products.map((p) => (p.slug === slug ? json : p));
			if (!products.some((p) => p.slug === slug)) merged.push(json);
			output.textContent = JSON.stringify(merged, null, 2);
		};

		form.addEventListener('input', (event) => {
			if (event.target.name === 'title' && !form.slug.value) {
				form.slug.value = slugify(event.target.value);
			}
			buildJSON();
		});

		imageButton.addEventListener('click', () => imageInput.click());
		imageInput.addEventListener('change', () => {
			const file = imageInput.files?.[0];
			if (!file) return;
			selectedFile = file;
			const url = URL.createObjectURL(file);
			imagePreview.src = url;
			imagePreview.alt = file.name;
			imageFilename.textContent = file.name;
			form.image.value = file.name;
			const reader = new FileReader();
			reader.onload = () => {
				imageDataUrl = reader.result;
				buildJSON();
			};
			reader.readAsDataURL(file);
		});

		const renderList = () => {
			listEl.innerHTML = '';
			if (!products.length) {
				listEl.innerHTML = '<p class="text-sm text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.</p>';
				return;
			}
			for (const item of products) {
				const card = document.createElement('div');
				card.className =
					'rounded-2xl border border-slate-200 bg-white p-4 shadow-[0_1px_0_#e2e8f0] flex flex-col gap-2';
				card.innerHTML = `
					<div class="flex items-center gap-3">
						<div class="h-12 w-12 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 overflow-hidden">
							${item.imageDataUrl ? `<img src="${item.imageDataUrl}" class="h-full w-full object-cover" />` : 'üì¶'}
						</div>
						<div class="min-w-0">
							<a href="/${item.slug}/" target="_blank" class="text-sm font-semibold text-slate-900 truncate hover:underline">${item.title}</a>
							<p class="text-xs text-slate-500 truncate">${item.slug}</p>
						</div>
					</div>
					<div class="flex gap-2">
						<button data-slug="${item.slug}" class="edit-btn rounded-lg border border-slate-300 px-3 py-1.5 text-xs font-semibold text-slate-900 hover:bg-slate-100">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
						<button data-slug="${item.slug}" class="delete-btn rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-100">–£–¥–∞–ª–∏—Ç—å</button>
					</div>
				`;
				listEl.appendChild(card);
			}
			listEl.querySelectorAll('.edit-btn').forEach((btn) =>
				btn.addEventListener('click', () => startEdit(btn.dataset.slug))
			);
			listEl.querySelectorAll('.delete-btn').forEach((btn) =>
				btn.addEventListener('click', () => deleteItem(btn.dataset.slug))
			);
		};

		const resetForm = () => {
			form.reset();
			imagePreview.src = '';
			imagePreview.alt = '–ü—Ä–µ–≤—å—é';
			imageFilename.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
			imageDataUrl = null;
			selectedFile = null;
			editingSlug = null;
			editLabel.classList.add('hidden');
			buildJSON();
		};

		const startEdit = (slug) => {
			const item = products.find((p) => p.slug === slug);
			if (!item) return;
			form.title.value = item.title;
			form.slug.value = item.slug;
			form.description.value = item.description;
			form.image.value = item.image;
			form.rating.value = item.rating;
			form.reviews.value = item.reviews;
			form.purchases.value = item.purchases;
			form.wb.value = item.links.wb || '';
			form.ozon.value = item.links.ozon || '';
			form.ym.value = item.links.ym || '';
			if (item.imageDataUrl) {
				imagePreview.src = item.imageDataUrl;
				imagePreview.alt = item.image;
				imageFilename.textContent = item.image;
				imageDataUrl = item.imageDataUrl;
			} else {
				imagePreview.src = '';
				imageFilename.textContent = item.image || '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
				imageDataUrl = null;
			}
			editingSlug = slug;
			editLabel.classList.remove('hidden');
			buildJSON();
		};

		const deleteItem = async (slug) => {
			if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?')) return;
			const ok = await saveRemote('DELETE', { slug });
			if (!ok) return;
			products = products.filter((p) => p.slug !== slug);
			persist();
			resetForm();
			renderList();
			buildJSON();
		};

		const getToken = () => localStorage.getItem('mp-token') || '';
		const setToken = (t) => localStorage.setItem('mp-token', t);

		const uploadImage = async () => {
			if (!selectedFile || !imageDataUrl) return null;
			const token = getToken();
			const res = await fetch('/api/upload', {
				method: 'POST',
				headers: {
					'content-type': 'application/json',
					'x-admin-token': token || ''
				},
				body: JSON.stringify({ fileName: selectedFile.name, dataUrl: imageDataUrl })
			});
			if (!res.ok) {
				alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
				return null;
			}
			const data = await res.json();
			return data.url;
		};

		const saveRemote = async (method, payload) => {
			const token = getToken();
			const res = await fetch(apiBase, {
				method,
				headers: {
					'content-type': 'application/json',
					'x-admin-token': token || ''
				},
				body: method === 'GET' ? undefined : JSON.stringify(payload)
			});
			if (!res.ok) {
				alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + res.status);
				return false;
			}
			return method === 'DELETE' ? true : await res.json();
		};

		const loadRemote = async () => {
			const res = await fetch(apiBase);
			if (!res.ok) return [];
			return await res.json();
		};

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const data = new FormData(form);
			const title = data.get('title')?.toString().trim() || '';
			const slugInput = data.get('slug')?.toString().trim() || '';
			const slug = slugInput || slugify(title);

			const json = {
				slug,
				title,
				description: data.get('description')?.toString().trim() || '',
				image: data.get('image')?.toString().trim() || '',
				rating: Number(data.get('rating') || 0) || 0,
				reviews: Number(data.get('reviews') || 0) || 0,
				purchases: Number(data.get('purchases') || 0) || 0,
				links: {
					wb: data.get('wb')?.toString().trim() || '',
					ozon: data.get('ozon')?.toString().trim() || '',
					ym: data.get('ym')?.toString().trim() || ''
				}
			};

			// –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ —Ñ–∞–π–ª ‚Äî –∑–∞–≥—Ä—É–∑–∏–º –∏ –ø–æ–¥–º–µ–Ω–∏–º image –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL
			if (selectedFile && imageDataUrl) {
				const uploadedUrl = await uploadImage();
				if (uploadedUrl) {
					json.image = uploadedUrl;
					imageDataUrl = null;
					selectedFile = null;
				}
			}

			const saved = await saveRemote('PUT', json);
			if (saved) {
				const exists = products.some((p) => p.slug === slug);
				if (exists) {
					products = products.map((p) => (p.slug === slug ? saved : p));
				} else {
					products.push(saved);
				}
				persist();
				renderList();
				buildJSON();
				editLabel.classList.add('hidden');
			}
		});

		resetBtn.addEventListener('click', resetForm);

		copyBtn.addEventListener('click', async () => {
			try {
				await navigator.clipboard.writeText(output.textContent.trim());
				copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
				setTimeout(() => (copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON'), 1200);
			} catch (e) {
				copyBtn.textContent = '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è';
			}
		});

		const downloadFile = (content, filename, type = 'application/json') => {
			const blob = new Blob([content], { type });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			document.body.appendChild(a);
			a.click();
			a.remove();
			URL.revokeObjectURL(url);
		};

		downloadJsonBtn.addEventListener('click', () => {
			downloadFile(output.textContent.trim(), 'products.json');
		});

		saveFsBtn.addEventListener('click', async () => {
			alert('–í —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä—è–º–æ –≤ —Ñ–∞–π–ª—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è: –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
		});

		const formContainer = form;
		const listContainer = document.getElementById('products-list');
		const listHint = document.getElementById('list-hint');

		const redirectToLogin = () => {
			window.location.href = '/login';
		};

		const tryUnlock = async () => {
			const val = getToken();
			if (!val) {
				return redirectToLogin();
			}
			const res = await fetch(apiBase, { headers: { 'x-admin-token': val } });
			if (!res.ok) {
				localStorage.removeItem('mp-token');
				return redirectToLogin();
			}
			const remote = await res.json();
			if (remote.length) {
				products = remote;
				persist();
			}
			formContainer.classList.remove('hidden');
			listContainer.classList.remove('hidden');
			listHint?.classList.remove('hidden');
			renderList();
			buildJSON();
		};

		tryUnlock();

		// init
		buildJSON();
	</script>
</BaseLayout>

